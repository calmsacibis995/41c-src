head     1.1;
access   ;
symbols  ;
locks    ;
comment  @ * @;


1.1
date     83.03.01.16.31.45;  author cooper;  state Exp;
branches ;
next     ;


desc
@Library routines for Courier clients.
@


1.1
log
@Initial revision
@
text
@#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <netdb.h>
#include <courier.h>

#if DEBUG
int CourierClientDebuggingFlag = 0;
#endif

/*
 * Message stream handle.
 */
static int msgs = -1;

SendCallMessage(procedure, nwords, arguments)
	Cardinal procedure, nwords;
	Unspecified *arguments;
{
	Cardinal p, n;

#if DEBUG
	if (CourierClientDebuggingFlag)
		fprintf(stderr, "[SendCallMessage %d %d]\n", procedure, nwords);
#endif
	PackCardinal(&procedure, &p, 1);
	PackCardinal(&nwords, &n, 1);
	write(msgs, &p, sizeof(Cardinal));
	write(msgs, &n, sizeof(Cardinal));
	write(msgs, arguments, nwords*sizeof(Unspecified));
}

Unspecified *
ReceiveReturnMessage()
{
	Cardinal nwords, n;
	Unspecified *bp;

	if (readmsg(&nwords, 1) == 0)
		goto eof;
	UnpackCardinal(&n, &nwords);
#if DEBUG
	if (CourierClientDebuggingFlag)
		fprintf(stderr, "[ReceiveReturnMessage %d]\n", n);
#endif
	bp = Allocate(n);
	if (readmsg(bp, n) == 0)
		goto eof;
	return (bp);
eof:
	fprintf(stderr, "\n\r\7Lost connection to server.\n");
	exit(1);
}

CourierActivate(host, program_name)
	String host, program_name;
{
	struct hostent *hp;
	struct servent *srvp;
	struct sockaddr_in sin;
	Unspecified buf[100];
	Cardinal n;
	char c;

	if (msgs >= 0)
		CourierClose();
	hp = gethostbyname(host);
	if (hp == 0) {
		fprintf(stderr, "%s: unknown host\n", host);
		return (-1);
	}
	srvp = getservbyname("courier", "tcp");
	if (srvp == 0) {
		fprintf(stderr, "tcp/courier: unknown service\n");
		return (-1);
	}
	msgs = socket(AF_INET, SOCK_STREAM, 0, 0);
	if (msgs < 0) {
		perror("socket");
		return (-1);
	}
	sin.sin_family = AF_INET;
	sin.sin_port = 0;
	sin.sin_addr.s_addr = 0;
	if (bind(msgs, (caddr_t)&sin, sizeof (sin), 0) < 0) {
		perror("bind");
		goto bad;
	}
	sin.sin_family = hp->h_addrtype;
	sin.sin_addr = *(struct in_addr *) hp->h_addr;
	sin.sin_port = srvp->s_port;
	if (connect(msgs, (caddr_t)&sin, sizeof(sin), 0) < 0) {
		perror(hp->h_name);
		goto bad;
	}
#if DEBUG
	if (CourierClientDebuggingFlag)
		fprintf(stderr, "[CourierActivate: connected to %s]\n",
			hp->h_name);
#endif
	n = PackString(&program_name, buf, 1);
	write(msgs, buf, n*sizeof(Unspecified));
	if (read(msgs, &c, 1) != 1) {
		perror(host);
		goto bad;
	}
	if (c != 0) {
		do write(2, &c, 1); while (read(msgs, &c, 1) == 1 && c != 0);
		goto bad;
	}
#if DEBUG
	if (CourierClientDebuggingFlag)
		fprintf(stderr, "[CourierActivate: running %s]\n",
			program_name);
#endif
	return (0);
bad:
	CourierClose();
	return (-1);
}

CourierClose()
{
	close(msgs);
	msgs = -1;
}

static
readmsg(addr, nwords)
	char *addr;
	int nwords;
{
	register int nbytes, n;
	register char *p;

	for (p = addr, nbytes = 2*nwords; nbytes > 0; nbytes -= n, p += n) {
		n = read(msgs, p, nbytes);
		if (n <= 0)
			return (0);
	}
	return (1);
}
@
